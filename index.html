<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatBot Evaluador de Respuesta Extendida GED (R√∫brica Oficial)</title>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        options: {
          enableMenu: false,
          processHtmlClass: 'tex2jax_process',
          ignoreHtmlClass: 'tex2jax_ignore'
        },
        startup: { pageReady: () => MathJax.startup.defaultPageReady() }
      };
    </script>
    <script id="MathJax-script" defer src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f0f8ff;
        color: #333;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: background-color 0.3s, color 0.3s;
      }
      body.dark { background-color: #1a2332; color: #e1ecf7; }

      h1 {
        background-color: #4a90e2;
        color: white;
        width: 100%;
        text-align: center;
        padding: 20px 0;
        margin: 0;
        text-shadow: 2px 2px #357abd;
      }

      .header-container {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }

      .help-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgb(124, 24, 128);
        color: white;
        border: none;
        font-size: 22px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }
      .help-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.1);
      }

      .help-modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .help-modal.active { display: flex; opacity: 1; }

      .help-content {
        width: 90%;
        max-width: 700px;
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        position: relative;
        max-height: 85vh;
        overflow-y: auto;
        border-top: 5px solid #4a90e2;
      }
      body.dark .help-content { background-color: #2a3847; color: #e1ecf7; }

      .close-help {
        position: absolute;
        top: 10px; right: 10px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }
      body.dark .close-help { color: #e1ecf7; }
      .close-help:hover { color: #4a90e2; }

      #chatbox {
        width: 90%;
        max-width: 900px;
        height: 450px;
        border: 1px solid #c5d9f0;
        overflow-y: auto;
        padding: 15px;
        margin-top: 20px;
        background: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: background-color 0.3s;
        border-radius: 8px;
      }
      body.dark #chatbox { background-color: #2a3847; color: #e1ecf7; border-color: #3a4d63; }

      .message { display: flex; align-items: start; gap: 10px; flex-wrap: wrap; position: relative; }
      .emoji-avatar { font-size: 40px; min-width: 40px; text-align: center; }

      .text-bubble {
        background-color: #e8f0fe;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 90%;
        word-wrap: break-word;
        position: relative;
        padding-right: 40px;
      }
      body.dark .text-bubble { background-color: #3a4d63; }

      .user .text-bubble { background-color: #dbe9ff; margin-left: auto; border-radius: 15px 5px 15px 15px; }
      .bot .text-bubble { border-radius: 5px 15px 15px 15px; }

      .evaluation-container {
        margin-top: 15px;
        padding: 15px;
        background-color: #f5f9ff;
        border-radius: 8px;
        border: 1px solid #d1e4ff;
      }
      body.dark .evaluation-container { background-color: #1e2938; border-color: #3a4d63; }

      .trait-evaluation {
        margin: 10px 0;
        padding: 10px;
        background-color: white;
        border-radius: 5px;
        border-left: 4px solid #4a90e2;
      }
      body.dark .trait-evaluation { background-color: #2a3847; border-left-color: #6aa6f8; }

      .trait-title { font-weight: bold; color: #357abd; margin-bottom: 5px; font-size: 16px; }
      body.dark .trait-title { color: #6aa6f8; }

      .score-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 15px;
        font-weight: bold;
        margin-left: 10px;
        font-size: 14px;
      }
      .score-0 { background-color: #ff4444; color: white; }
      .score-1 { background-color: #ff9944; color: white; }
      .score-2 { background-color: #44bb66; color: white; }

      .total-score {
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        margin-top: 15px;
        padding: 10px;
        background-color: #4a90e2;
        color: white;
        border-radius: 5px;
      }

      .warning-box {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      body.dark .warning-box { background-color: #3d2914; border-color: #6c5400; color: #ffc107; }

      .error-box {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      body.dark .error-box { background-color: #2d1b1e; border-color: #842029; color: #f8d7da; }

      .copy-btn {
        position: absolute;
        top: 8px; right: 8px;
        background: #4a90e2;
        color: white;
        border: none;
        border-radius: 5px;
        width: 32px; height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 10;
      }
      .copy-btn:hover { background: #357abd; transform: scale(1.1); }
      .copy-btn i { font-size: 16px; }

      .tooltip {
        position: absolute;
        background-color: #357abd;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        top: -30px; right: 0;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      .tooltip.show { opacity: 1; }

      #text-form {
        display: flex;
        flex-direction: column;
        width: 90%;
        max-width: 900px;
        margin-top: 20px;
      }

      textarea {
        padding: 15px;
        font-size: 16px;
        border: 1px solid #c5d9f0;
        border-radius: 8px;
        min-height: 200px;
        resize: vertical;
        margin-bottom: 15px;
        font-family: Arial, sans-serif;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      body.dark textarea { background-color: #2a3847; color: #e1ecf7; border-color: #3a4d63; }

      button {
        padding: 14px 20px;
        font-size: 18px;
        border: none;
        background-color: #4a90e2;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      button:hover { background-color: #357abd; transform: scale(1.02); }

      .toggle-btn {
        margin-top: 20px;
        margin-bottom: 30px;
        padding: 8px 16px;
        background-color: #357abd;
        font-size: 16px;
      }

      .loading-indicator {
        margin: 15px 0;
        text-align: center;
        color: #4a90e2;
        display: none;
        font-size: 18px;
        font-weight: bold;
      }

      @media (max-width: 768px) {
        .help-btn { width: 36px; height: 36px; font-size: 18px; right: 15px; }
        textarea { min-height: 180px; }
      }
      @media (max-width: 480px) {
        h1 { font-size: 20px; padding: 15px 0; }
        .help-btn { width: 32px; height: 32px; font-size: 16px; right: 10px; }
        textarea { min-height: 150px; font-size: 14px; }
        button { padding: 12px 15px; font-size: 16px; }
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <h1>
        Evaluador de la Respuesta Extendida del GED (R√∫brica Oficial)
        <br />
        <span style="font-size: 16px; font-weight: normal">Creada por Jos√© M. Fern√°ndez con Gemini Pro 2.5 y Claude Sonnet 4</span>
      </h1>
      <button class="help-btn" onclick="toggleHelp()">
        <i class="fas fa-question"></i>
      </button>
    </div>

    <!-- Modal de Ayuda -->
    <div class="help-modal" id="helpModal">
      <div class="help-content">
        <button class="close-help" onclick="toggleHelp()">
          <i class="fas fa-times"></i>
        </button>
        <h3>Evaluador GED con la R√∫brica Oficial</h3>
        <p><strong>Esta herramienta implementa la r√∫brica oficial del GED Testing Service</strong></p>
        <p>
          <strong style="color: #ff6b35">Esta herramienta aplica los criterios oficiales de manera estricta y realista.</strong>
          <br />
          No obstante, al no ser la herramienta verdadera del examen, puede no corresponderse con el resultado del examen oficial.
        </p>
        <h4>Sistema de Evaluaci√≥n Oficial</h4>
        <h5>üéØ Caracter√≠stica 1: Argumentaci√≥n y Uso de Evidencia (12 subdimensiones)</h5>
        <ul style="padding-left: 20px; margin: 10px 0">
          <li><strong>Requisito obligatorio:</strong> Debe citar evidencia espec√≠fica de AMBOS textos fuente</li>
          <li>Generar un argumento claro basado en los textos</li>
          <li>Analizar cu√°l posici√≥n est√° mejor sustentada</li>
          <li>Distinguir entre afirmaciones fundamentadas y no fundamentadas</li>
        </ul>
        <h5>üìä Caracter√≠stica 2: Desarrollo de Ideas y Estructura (15 subdimensiones)</h5>
        <ul style="padding-left: 20px; margin: 10px 0">
          <li>Ideas bien desarrolladas y l√≥gicas</li>
          <li>Progresi√≥n clara de ideas</li>
          <li>Estructura organizacional efectiva</li>
          <li>Uso apropiado de transiciones</li>
          <li>Estilo formal y tono acad√©mico</li>
        </ul>
        <h5>‚úèÔ∏è Caracter√≠stica 3: Claridad y Dominio del Espa√±ol (14 subdimensiones)</h5>
        <ul style="padding-left: 20px; margin: 10px 0">
          <li>Estructura correcta de oraciones</li>
          <li>Aplicaci√≥n de convenciones gramaticales</li>
          <li>Puntuaci√≥n y may√∫sculas apropiadas</li>
          <li>Legibilidad general</li>
        </ul>
        <h4>Requisitos M√≠nimos (CR√çTICOS)</h4>
        <div style="background-color: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0">
          <ul style="padding-left: 20px; margin: 5px 0">
            <li><strong>Longitud:</strong> 300-500 palabras (menos de 300 = penalizaci√≥n severa)</li>
            <li><strong>Estructura:</strong> 4-7 p√°rrafos organizados</li>
            <li><strong>Evidencia textual:</strong> Citas espec√≠ficas de AMBOS textos</li>
            <li><strong>An√°lisis comparativo:</strong> Determinar cu√°l argumento est√° mejor sustentado</li>
          </ul>
        </div>
        <h4>Sistema de Puntuaci√≥n Oficial</h4>
        <p>Cada caracter√≠stica se eval√∫a usando subdimensiones con puntuaci√≥n 0-2:</p>
        <ul style="padding-left: 20px; margin: 10px 0">
          <li><strong>0 puntos:</strong> No demuestra la habilidad</li>
          <li><strong>1 punto:</strong> Nivel m√≠nimo/inadecuado</li>
          <li><strong>2 puntos:</strong> Nivel adecuado/efectivo</li>
        </ul>
        <p><strong>F√≥rmula:</strong> (Suma de puntos) √∑ (N√∫mero de subdimensiones) = Puntuaci√≥n de caracter√≠stica</p>
        <p>Puntuaci√≥n m√°xima total: 6 puntos (2+2+2)</p>
      </div>
    </div>

    <div id="chatbox"></div>
    <div id="loading" class="loading-indicator">Aplicando r√∫brica oficial del GED...</div>

    <form id="text-form">
      <textarea
        id="user-input"
        placeholder="Pega aqu√≠ tu respuesta extendida para evaluaci√≥n con la r√∫brica oficial del GED. Esta herramienta aplica los criterios reales del examen y dar√° puntuaciones m√°s realistas y estrictas."
        autocomplete="off"
        required></textarea>
      <button type="submit">Evaluar con R√∫brica Oficial GED</button>
    </form>

    <button class="toggle-btn" onclick="toggleTheme()">
      <i class="fas fa-moon"></i> / <i class="fas fa-sun"></i> Cambiar tema
    </button>

    <script>
      // ‚îÄ‚îÄ‚îÄ URL del backend en Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const BACKEND_URL = "https://math-backend-zs9j.onrender.com/generate";

      const cache = { responses: {} };
      const chatbox       = document.getElementById('chatbox');
      const form          = document.getElementById('text-form');
      const userInput     = document.getElementById('user-input');
      const loadingIndicator = document.getElementById('loading');
      const helpModal     = document.getElementById('helpModal');

      function getEmoji(type) { return type === 'user' ? 'üìù' : 'üéì'; }

      function toggleHelp() { helpModal.classList.toggle('active'); }

      function toggleTheme() {
        document.body.classList.toggle('dark');
        localStorage.setItem('darkMode', document.body.classList.contains('dark'));
      }

      helpModal.addEventListener('click', function(e) {
        if (e.target === helpModal) toggleHelp();
      });

      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), wait);
        };
      }

      const renderMathJax = debounce(function(elements) {
        if (window.MathJax && window.MathJax.typeset) {
          window.MathJax.typeset(elements);
        }
      }, 100);

      function copyTextToClipboard(text) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = text;
        const plainText = tempDiv.textContent || tempDiv.innerText || '';
        navigator.clipboard.writeText(plainText).catch(() => fallbackCopy(plainText));
      }

      function fallbackCopy(text) {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.cssText = 'position:fixed;top:0;left:0;opacity:0;';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        try { document.execCommand('copy'); } catch(e) {}
        document.body.removeChild(ta);
      }

      function addMessage(text, className, emoji) {
        const message = document.createElement('div');
        message.className = `message ${className}`;

        const emojiSpan = document.createElement('span');
        emojiSpan.className = 'emoji-avatar';
        emojiSpan.textContent = emoji;

        const bubble = document.createElement('div');
        bubble.className = 'text-bubble tex2jax_process';
        bubble.innerHTML = text;

        message.appendChild(emojiSpan);
        message.appendChild(bubble);

        if (className === 'bot') {
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-btn';
          copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
          copyBtn.title = 'Copiar evaluaci√≥n';

          const tooltip = document.createElement('span');
          tooltip.className = 'tooltip';
          tooltip.innerText = '¬°Copiado!';

          copyBtn.addEventListener('click', function() {
            copyTextToClipboard(text);
            tooltip.classList.add('show');
            setTimeout(() => tooltip.classList.remove('show'), 2000);
          });

          bubble.appendChild(copyBtn);
          bubble.appendChild(tooltip);
        }

        chatbox.appendChild(message);
        chatbox.scrollTop = chatbox.scrollHeight;
        renderMathJax([bubble]);
      }

      function analyzeTextStructure(texto) {
        const numPalabras     = texto.split(/\s+/).filter(p => p.length > 0).length;
        const numParrafos     = texto.split(/\n\n+|\.\s*\n/).filter(p => p.trim().length > 0).length;
        const referenciaTextos = /texto|pasaje|autor|fuente|art√≠culo|documento/gi.test(texto);
        const citasDirectas   = /"[^"]+"/g.test(texto) || /seg√∫n|cita|menciona|afirma/gi.test(texto);
        const argumentativo   = /por tanto|en conclusi√≥n|sin embargo|adem√°s|por otro lado|en contraste/gi.test(texto);
        return {
          numPalabras, numParrafos, referenciaTextos, citasDirectas, argumentativo,
          longitudAdecuada:  numPalabras >= 300 && numPalabras <= 500,
          estructuraAdecuada: numParrafos >= 4 && numParrafos <= 7
        };
      }

      // ‚îÄ‚îÄ‚îÄ FUNCI√ìN PRINCIPAL ‚Äî LLAMA AL BACKEND EN RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function getBotResponse(ensayo) {

        // Devolver respuesta cacheada si ya existe
        if (cache.responses[ensayo]) return cache.responses[ensayo];

        const analisis = analyzeTextStructure(ensayo);

        // Texto demasiado corto ‚Üí evaluaci√≥n autom√°tica sin llamar al backend
        if (analisis.numPalabras < 200) {
          return `<div class="evaluation-container">
            <div class="error-box">
              <strong>‚ö†Ô∏è EVALUACI√ìN AUTOM√ÅTICA: INSUFICIENTE</strong><br>
              El texto es demasiado corto (${analisis.numPalabras} palabras). El GED requiere m√≠nimo 300 palabras.
            </div>
            <div class="trait-evaluation">
              <div class="trait-title">Caracter√≠stica 1: Argumentaci√≥n y Uso de Evidencia <span class="score-badge score-0">0/2</span></div>
              <p>Texto insuficiente para demostrar argumentaci√≥n basada en textos fuente.</p>
            </div>
            <div class="trait-evaluation">
              <div class="trait-title">Caracter√≠stica 2: Desarrollo de Ideas y Estructura <span class="score-badge score-0">0/2</span></div>
              <p>Desarrollo insuficiente de ideas por limitaci√≥n de longitud.</p>
            </div>
            <div class="trait-evaluation">
              <div class="trait-title">Caracter√≠stica 3: Claridad y Dominio del Espa√±ol <span class="score-badge score-0">0/2</span></div>
              <p>Muestra insuficiente para evaluar dominio del espa√±ol.</p>
            </div>
            <div class="total-score">Puntuaci√≥n Total: 0/6</div>
          </div>`;
        }

        // ‚îÄ‚îÄ Construir el prompt para el modelo ‚îÄ‚îÄ
        const prompt = `INSTRUCCI√ìN CR√çTICA: Eres un evaluador certificado del GED Testing Service. Debes aplicar ESTRICTAMENTE la r√∫brica oficial con las 41 subdimensiones espec√≠ficas. NO seas permisivo - aplica los criterios reales del examen.

TEXTO A EVALUAR:
${ensayo}

INFORMACI√ìN DEL AN√ÅLISIS PRELIMINAR:
- Palabras: ${analisis.numPalabras}
- P√°rrafos: ${analisis.numParrafos}
- Referencias a textos: ${analisis.referenciaTextos ? 'Detectadas' : 'No detectadas'}
- Citas directas: ${analisis.citasDirectas ? 'Presentes' : 'Ausentes'}

R√öBRICA OFICIAL A APLICAR:

CARACTER√çSTICA 1: ARGUMENTACI√ìN Y USO DE EVIDENCIA (12 subdimensiones)
Eval√∫a cada subdimensi√≥n con puntuaci√≥n 0, 1, o 2:
1. Afirmaciones claras y expl√≠citas
2. Afirmaciones l√≥gicas basadas en lectura detallada del texto
3. Afirmaciones que apoyan una postura clara
4. Criterio evidente para analizar el asunto
5. Postura relacionada con el tema y enfocada
6. OBLIGATORIO: Citar evidencias de M√öLTIPLES textos fuente
7. Evidencias que apoyan las afirmaciones
8. Comentarios apropiados sobre las evidencias
9. An√°lisis profundo del asunto descrito
10. Evaluaci√≥n de la argumentaci√≥n desarrollada
11. Comprensi√≥n clara de los argumentos en los textos
12. Distinci√≥n entre afirmaciones fundamentadas y no fundamentadas

CARACTER√çSTICA 2: DESARROLLO DE IDEAS Y ESTRUCTURA (15 subdimensiones)
1. Ideas bien desarrolladas y m√∫ltiples extensiones
2. Ideas l√≥gicas en relaci√≥n con los textos
3. Mayor√≠a de ideas elaboradas
4. Serie progresiva de ideas notoria
5. Detalles relacionados claramente con ideas principales
6. Detalles seleccionados cuidadosamente
7. Estructura organizacional claramente establecida
8. Estructura que realza el mensaje
9. Uso apropiado de frases de transici√≥n
10. Estilo formal mantenido
11. Tono apropiado acad√©mico
12. Conciencia del p√∫blico y prop√≥sito
13. Selecci√≥n espec√≠fica de palabras
14. Uso apropiado del lenguaje (evitar coloquial)
15. Ideas expresadas clara y espec√≠ficamente

CARACTER√çSTICA 3: CLARIDAD Y DOMINIO DEL ESPA√ëOL (14 subdimensiones)
1. Estructura variada en oraciones
2. Subordinaci√≥n, coordinaci√≥n y paralelismo correctos
3. Evita palabras excesivas y estructuras confusas
4. Uso apropiado de t√©rminos de transici√≥n
5. Evita oraciones incompletas y mal puntuadas
6. Uso correcto de modos verbales
7. Concordancia sujeto-verbo apropiada
8. Uso apropiado de pronombres
9. Orden correcto de palabras
10. Uso apropiado de may√∫sculas
11. Uso correcto de contracciones
12. Puntuaci√≥n apropiada
13. Errores que no interfieren en comprensi√≥n
14. Uso est√°ndar apropiado para borrador acad√©mico

REQUISITOS CR√çTICOS (penalizar severamente si faltan):
- M√≠nimo 300 palabras
- 4-7 p√°rrafos organizados
- OBLIGATORIO: Evidencia espec√≠fica de DOS textos fuente diferentes
- An√°lisis comparativo de argumentos

INSTRUCCI√ìN DE FORMATO: Devuelve √öNICAMENTE el HTML indicado a continuaci√≥n. NO uses markdown, NO pongas bloques de c√≥digo, NO agregues texto antes ni despu√©s del HTML.

<div class="evaluation-container">
  <h3>Evaluaci√≥n Oficial GED - R√∫brica Certificada</h3>

  <div class="trait-evaluation">
    <div class="trait-title">Caracter√≠stica 1: Argumentaci√≥n y Uso de Evidencia <span class="score-badge score-[X]">[X]/2</span></div>
    <p><strong>Subdimensiones evaluadas:</strong> Lista cu√°les cumplen (‚úÖ) y cu√°les no (‚ùå), con breve explicaci√≥n.</p>
    <p><strong>Puntuaci√≥n promedio:</strong> [suma total] √∑ 12 = [X redondeado]</p>
    <p><strong>Problemas detectados:</strong> Descripci√≥n espec√≠fica de las deficiencias seg√∫n r√∫brica.</p>
  </div>

  <div class="trait-evaluation">
    <div class="trait-title">Caracter√≠stica 2: Desarrollo de Ideas y Estructura <span class="score-badge score-[Y]">[Y]/2</span></div>
    <p><strong>Subdimensiones evaluadas:</strong> Lista cu√°les cumplen (‚úÖ) y cu√°les no (‚ùå), con breve explicaci√≥n.</p>
    <p><strong>Puntuaci√≥n promedio:</strong> [suma total] √∑ 15 = [Y redondeado]</p>
    <p><strong>Problemas detectados:</strong> Descripci√≥n espec√≠fica de las deficiencias seg√∫n r√∫brica.</p>
  </div>

  <div class="trait-evaluation">
    <div class="trait-title">Caracter√≠stica 3: Claridad y Dominio del Espa√±ol <span class="score-badge score-[Z]">[Z]/2</span></div>
    <p><strong>Subdimensiones evaluadas:</strong> Lista cu√°les cumplen (‚úÖ) y cu√°les no (‚ùå), con breve explicaci√≥n.</p>
    <p><strong>Puntuaci√≥n promedio:</strong> [suma total] √∑ 14 = [Z redondeado]</p>
    <p><strong>Problemas detectados:</strong> Descripci√≥n espec√≠fica de las deficiencias seg√∫n r√∫brica.</p>
  </div>

  <div class="total-score">Puntuaci√≥n Total: [X+Y+Z]/6</div>

  <h4>Veredicto Final</h4>
  <p>[Evaluaci√≥n honesta del nivel de la respuesta seg√∫n est√°ndares GED reales. S√© directo sobre las deficiencias.]</p>
</div>

RECORDATORIO FINAL:
- NO infles puntuaciones, s√© estricto y realista
- Una respuesta sin citas de AMBOS textos NO puede obtener m√°s de 1 punto en Caracter√≠stica 1
- Indica con exactitud qu√© subdimensiones pasan y cu√°les fallan`;

        // ‚îÄ‚îÄ Llamada al backend en Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        try {
          const response = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              messages: [
                { role: "user", content: prompt }
              ]
            })
          });

          if (!response.ok) {
            // Intentar leer el cuerpo del error
            const errBody = await response.json().catch(() => ({}));
            throw new Error(errBody.error?.message || `Error HTTP ${response.status}`);
          }

          const json = await response.json();

          // Compatibilidad: el backend puede devolver OpenAI-style o {content: ...}
          let data = "";
          if (json.choices && json.choices[0]?.message?.content) {
            data = json.choices[0].message.content.trim();
          } else if (json.content) {
            data = json.content.trim();
          } else {
            throw new Error("Respuesta inesperada del backend: " + JSON.stringify(json));
          }

          // Limpiar si el modelo a√±adi√≥ bloques de c√≥digo markdown
          data = data
            .replace(/^```html\s*/i, '')
            .replace(/^```\s*/i, '')
            .replace(/\s*```$/i, '')
            .trim();

          cache.responses[ensayo] = data;
          return data;

        } catch (error) {
          console.error('Error al llamar al backend:', error);
          return `<div class="evaluation-container">
            <div class="error-box">
              <strong>‚ö†Ô∏è Error al conectar con el backend:</strong> ${error.message}<br><br>
              Posibles causas:<br>
              ‚Ä¢ El servidor en Render est√° dormido (espera ~30 s y reintenta)<br>
              ‚Ä¢ URL del backend incorrecta<br>
              ‚Ä¢ Problema de conexi√≥n a internet<br><br>
              URL usada: <code>${BACKEND_URL}</code><br>
              Revisa la consola del navegador (F12) para m√°s detalles.
            </div>
          </div>`;
        }
      }

      // ‚îÄ‚îÄ‚îÄ MANEJADOR DEL FORMULARIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function handleSendMessage(e) {
        e.preventDefault();
        const userText = userInput.value.trim();
        if (!userText) return;

        addMessage(userText, 'user', getEmoji('user'));
        userInput.value = '';
        loadingIndicator.style.display = 'block';

        try {
          const botResponse = await getBotResponse(userText);
          loadingIndicator.style.display = 'none';
          addMessage(botResponse, 'bot', getEmoji('bot'));
        } catch (error) {
          console.error('Error al procesar:', error);
          loadingIndicator.style.display = 'none';
          addMessage('Error al procesar la evaluaci√≥n. Por favor, intenta nuevamente.', 'bot', getEmoji('bot'));
        }
      }

      // ‚îÄ‚îÄ‚îÄ INICIALIZACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('darkMode') === 'true') {
          document.body.classList.add('dark');
        }

        setTimeout(() => {
          addMessage(
            '¬°Hola! Soy el evaluador GED con <strong>r√∫brica oficial</strong>.<br><br>' +
            '<div class="warning-box">‚ö†Ô∏è Esta herramienta aplica los criterios reales del GED Testing Service de manera estricta. No esperes puntuaciones infladas.</div><br>' +
            'Implementa las <strong>41 subdimensiones oficiales</strong>:<br>' +
            '‚Ä¢ Caracter√≠stica 1: 12 subdimensiones (Argumentaci√≥n)<br>' +
            '‚Ä¢ Caracter√≠stica 2: 15 subdimensiones (Desarrollo)<br>' +
            '‚Ä¢ Caracter√≠stica 3: 14 subdimensiones (Espa√±ol)<br><br>' +
            '<strong>Requisitos cr√≠ticos:</strong><br>' +
            '‚Ä¢ 300-500 palabras<br>' +
            '‚Ä¢ 4-7 p√°rrafos<br>' +
            '‚Ä¢ Evidencia de AMBOS textos fuente<br>' +
            '‚Ä¢ An√°lisis comparativo de argumentos<br><br>' +
            'Pega tu respuesta extendida para recibir una evaluaci√≥n realista seg√∫n los est√°ndares oficiales del GED.',
            'bot',
            getEmoji('bot')
          );
        }, 100);
      });

      form.addEventListener('submit', handleSendMessage);
    </script>
  </body>
</html>
